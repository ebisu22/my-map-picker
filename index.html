<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>æ•£æ­©ãƒ•ã‚©ãƒˆãƒãƒƒãƒ—</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; width: 100%; height: 100dvh; display: flex; flex-direction: column; font-family: sans-serif; }
        
        /* åœ°å›³ã‚¨ãƒªã‚¢ */
        #map { flex-grow: 1; width: 100%; position: relative; }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ï¼ˆåœ°å›³ã®ä¸Šã«é‡ã­ã‚‹ï¼‰ */
        .form-panel {
            background: #fff; padding: 15px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
        }
        
        input[type="text"] {
            padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px;
        }
        
        /* å†™çœŸé¸æŠãƒœã‚¿ãƒ³ã‚’ãŠã—ã‚ƒã‚Œã« */
        .file-upload {
            display: flex; align-items: center; gap: 10px;
        }
        input[type="file"] { font-size: 14px; }

        .btn-group { display: flex; gap: 10px; }
        button {
            padding: 12px; font-size: 16px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; flex: 1;
        }
        .btn-save { background-color: #e74c3c; } /* èµ¤ï¼šä¿å­˜ */
        .btn-gps { background-color: #28a745; flex: 0 0 60px; } /* ç·‘ï¼šç¾åœ¨åœ° */

        /* ä¿å­˜ã•ã‚ŒãŸãƒ”ãƒ³ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ç”»åƒ */
        .popup-img { width: 150px; height: auto; border-radius: 5px; margin-top: 5px; }
        .popup-title { font-weight: bold; font-size: 1.1em; }
        .delete-btn { color: red; cursor: pointer; text-decoration: underline; font-size: 0.9em; margin-top: 5px; display: block;}
    </style>
</head>
<body>

<div id="map"></div>

<div class="form-panel">
    <div style="display:flex; gap:5px;">
        <input type="text" id="input-title" placeholder="ã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ãã‚Œã„ãªèŠ±)" style="flex:1;">
        <button class="btn-gps" onclick="getLocation()">ğŸ“</button>
    </div>
    
    <div class="file-upload">
        <input type="file" id="input-image" accept="image/*">
    </div>

    <button class="btn-save" id="save-btn" onclick="savePin()">ğŸ“¸ ã“ã®å ´æ‰€ã‚’ä¿å­˜</button>
</div>

<script>
    // 1. åœ°å›³ã®åˆæœŸåŒ–
    var map = L.map('map').setView([35.681236, 139.767125], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var currentLocMarker = null; // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼

    // 2. èµ·å‹•æ™‚ã«ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    loadPins();

    // --- æ©Ÿèƒ½é–¢æ•° ---

    // ç¾åœ¨åœ°å–å¾—
    function getLocation() {
        if (!navigator.geolocation) return alert("GPSéå¯¾å¿œ");
        
        navigator.geolocation.getCurrentPosition(function(pos) {
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            map.setView([lat, lng], 18);
            
            // ç¾åœ¨åœ°ã ã‘ã¯é’ã„ä¸¸ã§è¡¨ç¤ºï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¨ã¯åˆ¥ï¼‰
            if (currentLocMarker) map.removeLayer(currentLocMarker);
            currentLocMarker = L.circleMarker([lat, lng], { color: 'white', fillColor: '#28a745', fillOpacity: 1, radius: 8 }).addTo(map);
        }, function() { alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"); });
    }

    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ™‚ã®å‡¦ç†
    async function savePin() {
        var title = document.getElementById('input-title').value;
        var fileInput = document.getElementById('input-image');
        
        if (!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

        // ãƒœã‚¿ãƒ³ã‚’ã€Œä¿å­˜ä¸­...ã€ã«ã—ã¦é€£æ‰“é˜²æ­¢
        var btn = document.getElementById('save-btn');
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        var center = map.getCenter();
        var timestamp = new Date().getTime(); // IDä»£ã‚ã‚Š
        var imageData = null;

        // ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã€åœ§ç¸®å‡¦ç†ã‚’è¡Œã†
        if (fileInput.files && fileInput.files[0]) {
            try {
                imageData = await compressImage(fileInput.files[0]);
            } catch (e) {
                alert("ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e);
                resetButton();
                return;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ã¾ã¨ã‚ã‚‹
        var pinData = {
            id: timestamp,
            lat: center.lat,
            lng: center.lng,
            title: title,
            image: imageData // åœ§ç¸®ã•ã‚ŒãŸç”»åƒãƒ‡ãƒ¼ã‚¿(Base64)
        };

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
        saveToStorage(pinData);
        
        // åœ°å›³ã«ãƒ”ãƒ³ã‚’ç«‹ã¦ã‚‹
        addMarkerToMap(pinData);

        // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('input-title').value = "";
        document.getElementById('input-image').value = "";
        alert("ä¿å­˜ã—ã¾ã—ãŸï¼");
        resetButton();
    }

    function resetButton() {
        var btn = document.getElementById('save-btn');
        btn.innerText = "ğŸ“¸ ã“ã®å ´æ‰€ã‚’ä¿å­˜";
        btn.disabled = false;
    }

    // â˜…é‡è¦ï¼šç”»åƒã‚’åœ§ç¸®ã™ã‚‹é–¢æ•°ï¼ˆã“ã‚Œã§å›ºã¾ã‚‹ã®ã‚’é˜²ãï¼‰
    function compressImage(file) {
        return new Promise((resolve, reject) => {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                var img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œã£ã¦æç”»ã—ç›´ã™ï¼ˆã“ã“ã§ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ï¼‰
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    
                    // æœ€å¤§å¹…ã‚’800pxã«åˆ¶é™
                    var maxWidth = 800;
                    var scaleSize = maxWidth / img.width;
                    if (scaleSize > 1) scaleSize = 1; // å…ƒãŒå°ã•ã„ãªã‚‰ãã®ã¾ã¾

                    canvas.width = img.width * scaleSize;
                    canvas.height = img.height * scaleSize;

                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    
                    // JPEGå½¢å¼ã€å“è³ª0.7ï¼ˆ70%ï¼‰ã§åœ§ç¸®ã—ã¦æ–‡å­—åˆ—ã«ã™ã‚‹
                    var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(dataUrl);
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¸ã®ä¿å­˜
    function saveToStorage(data) {
        var pins = JSON.parse(localStorage.getItem('walk_pins') || "[]");
        pins.push(data);
        
        // å®¹é‡ã‚ãµã‚Œå¯¾ç­–ï¼ˆå¤ã„é †ã«æ¶ˆã™ãªã©ã®å‡¦ç†ãŒå¿…è¦ã ãŒã€ä»Šå›ã¯ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã®ã¿ï¼‰
        try {
            localStorage.setItem('walk_pins', JSON.stringify(pins));
        } catch(e) {
            alert("ä¿å­˜å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å¤ã„ãƒ”ãƒ³ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚");
        }
    }

    // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§åœ°å›³ã«è¡¨ç¤º
    function loadPins() {
        var pins = JSON.parse(localStorage.getItem('walk_pins') || "[]");
        pins.forEach(function(pin) {
            addMarkerToMap(pin);
        });
    }

    // åœ°å›³ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ ã™ã‚‹
    function addMarkerToMap(pin) {
        var popupContent = `<div class="popup-title">${pin.title}</div>`;
        if (pin.image) {
            popupContent += `<img src="${pin.image}" class="popup-img">`;
        }
        popupContent += `<span class="delete-btn" onclick="deletePin(${pin.id})">å‰Šé™¤ã™ã‚‹</span>`;

        var marker = L.marker([pin.lat, pin.lng]).addTo(map)
            .bindPopup(popupContent);
        
        // å‰Šé™¤æ©Ÿèƒ½ã®ãŸã‚ã«ãƒãƒ¼ã‚«ãƒ¼ã«IDã‚’ç´ä»˜ã‘ã¦ãŠã
        marker.pinId = pin.id;
    }

    // ãƒ”ãƒ³ã®å‰Šé™¤æ©Ÿèƒ½
    window.deletePin = function(id) {
        if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;

        var pins = JSON.parse(localStorage.getItem('walk_pins') || "[]");
        var newPins = pins.filter(p => p.id !== id);
        localStorage.setItem('walk_pins', JSON.stringify(newPins));
        
        // ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦åæ˜ 
        location.reload();
    }
</script>

</body>
</html>
