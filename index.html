<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Êï£Ê≠©„Éï„Ç©„Éà„Éû„ÉÉ„Éó</title>
    
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" href="icon.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; width: 100%; height: 100dvh; display: flex; flex-direction: column; font-family: sans-serif; }
        
        #map { flex-grow: 1; width: 100%; position: relative; }

        .form-panel {
            background: #fff; padding: 15px;
            padding-bottom: calc(15px + env(safe-area-inset-bottom));
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            display: flex; flex-direction: column; gap: 10px;
        }
        
        input[type="text"] {
            padding: 10px; font-size: 16px; border: 1px solid #ccc; border-radius: 5px;
        }
        
        .file-upload { display: flex; align-items: center; gap: 10px; }
        input[type="file"] { font-size: 14px; }

        .btn-group { display: flex; gap: 10px; }
        button {
            padding: 12px; font-size: 16px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; flex: 1;
        }
        .btn-save { background-color: #e74c3c; }
        .btn-gps { background-color: #28a745; flex: 0 0 60px; }

        .popup-img { width: 150px; height: auto; border-radius: 5px; margin-top: 5px; }
        .popup-title { font-weight: bold; font-size: 1.1em; }
        .delete-btn { color: red; cursor: pointer; text-decoration: underline; font-size: 0.9em; margin-top: 5px; display: block;}
    </style>
</head>
<body>

<div id="map"></div>

<div class="form-panel">
    <div style="display:flex; gap:5px;">
        <input type="text" id="input-title" placeholder="„Çø„Ç§„Éà„É´ (‰æã: „Åç„Çå„ÅÑ„Å™Ëä±)" style="flex:1;">
        <button class="btn-gps" onclick="getLocation()">üìç</button>
    </div>
    
    <div class="file-upload">
        <input type="file" id="input-image" accept="image/*">
    </div>

    <button class="btn-save" id="save-btn" onclick="savePin()">üì∏ „Åì„ÅÆÂ†¥ÊâÄ„Çí‰øùÂ≠ò</button>
</div>

<script>
    var map = L.map('map').setView([35.681236, 139.767125], 15);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    var currentLocMarker = null;
    loadPins();

    function getLocation() {
        if (!navigator.geolocation) return alert("GPSÈùûÂØæÂøú");
        navigator.geolocation.getCurrentPosition(function(pos) {
            var lat = pos.coords.latitude;
            var lng = pos.coords.longitude;
            map.setView([lat, lng], 18);
            if (currentLocMarker) map.removeLayer(currentLocMarker);
            currentLocMarker = L.circleMarker([lat, lng], { color: 'white', fillColor: '#28a745', fillOpacity: 1, radius: 8 }).addTo(map);
        }, function() { alert("ÁèæÂú®Âú∞„ÇíÂèñÂæó„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü"); });
    }

    async function savePin() {
        var title = document.getElementById('input-title').value;
        var fileInput = document.getElementById('input-image');
        
        if (!title) return alert("„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ");

        var btn = document.getElementById('save-btn');
        btn.innerText = "‰øùÂ≠ò‰∏≠...";
        btn.disabled = true;

        var center = map.getCenter();
        var timestamp = new Date().getTime();
        var imageData = null;

        if (fileInput.files && fileInput.files[0]) {
            try {
                imageData = await compressImage(fileInput.files[0]);
            } catch (e) {
                alert("ÁîªÂÉè„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: " + e);
                resetButton();
                return;
            }
        }

        var pinData = {
            id: timestamp, lat: center.lat, lng: center.lng, title: title, image: imageData
        };

        saveToStorage(pinData);
        addMarkerToMap(pinData);

        document.getElementById('input-title').value = "";
        document.getElementById('input-image').value = "";
        alert("‰øùÂ≠ò„Åó„Åæ„Åó„ÅüÔºÅ");
        resetButton();
    }

    function resetButton() {
        var btn = document.getElementById('save-btn');
        btn.innerText = "üì∏ „Åì„ÅÆÂ†¥ÊâÄ„Çí‰øùÂ≠ò";
        btn.disabled = false;
    }

    function compressImage(file) {
        return new Promise((resolve, reject) => {
            var reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                var img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    var canvas = document.createElement('canvas');
                    var ctx = canvas.getContext('2d');
                    var maxWidth = 800;
                    var scaleSize = maxWidth / img.width;
                    if (scaleSize > 1) scaleSize = 1;
                    canvas.width = img.width * scaleSize;
                    canvas.height = img.height * scaleSize;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    var dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(dataUrl);
                };
                img.onerror = reject;
            };
            reader.onerror = reject;
        });
    }

    function saveToStorage(data) {
        var pins = JSON.parse(localStorage.getItem('walk_pins') || "[]");
        pins.push(data);
        try {
            localStorage.setItem('walk_pins', JSON.stringify(pins));
        } catch(e) {
            alert("‰øùÂ≠òÂÆπÈáè„Åå„ÅÑ„Å£„Å±„ÅÑ„Åß„Åô„ÄÇÂè§„ÅÑ„Éî„É≥„ÇíÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        }
    }

    function loadPins() {
        var pins = JSON.parse(localStorage.getItem('walk_pins') || "[]");
        pins.forEach(function(pin) {
            addMarkerToMap(pin);
        });
    }

    function addMarkerToMap(pin) {
        var popupContent = `<div class="popup-title">${pin.title}</div>`;
        if (pin.image) {
            popupContent += `<img src="${pin.image}" class="popup-img">`;
        }
        popupContent += `<span class="delete-btn" onclick="deletePin(${pin.id})">ÂâäÈô§„Åô„Çã</span>`;
        var marker = L.marker([pin.lat, pin.lng]).addTo(map).bindPopup(popupContent);
        marker.pinId = pin.id;
    }

    window.deletePin = function(id) {
        if(!confirm("„Åì„ÅÆË®òÈå≤„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")) return;
        var pins = JSON.parse(localStorage.getItem('walk_pins') || "[]");
        var newPins = pins.filter(p => p.id !== id);
        localStorage.setItem('walk_pins', JSON.stringify(newPins));
        location.reload();
    }
</script>

</body>
</html>
